# 内存模型
# 类加载
## 类加载机制
## 类加载器
# GC
## 引用类型
## Algorithm
### 判断方式
#### 可达性分析
#### 回收对象
### 回收算法
#### 标记清除（mark-sweep）
#### 标记拷贝（mark-copy）
#### 标记交换（mark-compact）
#### 分代收集（generation-collection）
## 内存碎片
## 回收流程
### RSets
### 写屏障
## STW
# 堆内存
## 内存模型
### 分代模型
分为新生代和老年代，另外还有永久代。  
新生代：占用空间较老年代小些，经过了多次 Minor GC未 被回收的新生代会晋升为老年代。  
老年代：存活时间久，占用内存大。  
不同年代采用的回收策略和算法也不同，新生代多为 Minor GC，频率快，相对简单，老年代采用的 Full GC，耗时较久。
### 区域模型
内存区域越小，占用空间小，对象存活量小，GC 效率越高。  
基于 Region 的布局模型，老年代和新生代为一个区域的属性，每个区域大小相等，此外还有独占空间针对超过一个Region一半大小的超大型对象。
#### G1
面向大内存，多处理器的场景，并发 GC，且部分工作可以和程序同步执行，不会完全阻塞程序运行，通过 Region 的动态分配实现逻辑上的连续。  
可以预估每一次 Full GC 的时间，Region 大小一致，根据停顿时间可以算出此次 GC 回收 Region 的个数，无需全部清理，可以根据业务，针对某些 Region 回收，按照价值来回收，缩小范围提高效率。  
年轻代GC 会暂停应用线程，并发回收，将存活对象移动到老年区或另外的年轻代 survivor 区（to/from），接着老年代并发标记默认内存使用到45%，一次只扫描/回收一部分老年代， 之后会进行 Mixed GC，老年和年轻一起回收，其实就是针对 Rgion 回收，其实 Full GC 也存在，这种强力回收针对 GC 的评估失败提供保护机制，比如处理时空间耗尽了、回收时没有空间放下晋升的对象。  
回收的 Region 中存活对象会被复制到空的 Region，除并发标记外，其他过程均会 STW。
#### ZCG
一般情况一个 Region 放不满会浪费，因此有了更精细的管理将 Region 按照大中小区分，可动态调整 Region 大小，会产生更少的内存碎片和更大的内存利用率，以及对时间更加精准的管理。    
此外，不对 Region 分区，每次回收都是并发对所有 Region 执行，全并发 GC，标记、重定位、转移几乎都是并发执行，转移过程应用线程也可以访问对象，通过读屏障保证获取的地址正确，STW很短，减少更新记录开销以及记录内存占用。
##### 着色指针
将信息存储在指针，重新定义了虚拟内存和物理内存的映射关系，支持64位系统，将虚拟内存分为五个空间。  
0-4TB：Java Heap，创建对象时先在此申请，但不会映射到物理内存，他会对应 M0、M1、Remmaped 三个空间地址，并 同时在 M0、M1、Remmaped 申请一个虚拟地址，三个地址对应同一个物理地址，但是同一时间只有一个空间生效    
4-8TB：M0  
8-12TB：M1  
12-16TB：预留  
16-20TB：Remmaped  
实际只使用 42 位（0-41），所以可分配最大内存为 4TB（42 位最大寻址空间），此外，42-45 就是 color pointers，42/43/44 分别设置 1 则表示采用对应的视图，对应不同的地址空间，存储对象存活信息，不放在对象头中了，47-63 位固定为 0
##### 读屏障
JVM 向应用插入代码，当应用线程从堆中读取对象引用时执行，对象标记和转移时，确定对象的引用地址是否满足条件，不满足需要更新地址信息，将从堆中对象的引用读取的指针更新到对象的新地址上，无需STW。
初始化：地址视图为Remapped。  
并发标记：第一次进入标记阶段视图为 M0，对象被 GC 标记线程或应用线程访问过，地址视图从 Remapped 到 M0，其中 M0 为活跃的，Remapped 视为不活跃。  
并发转移：地址视图再次设为 Remapped，对象被 GC 转移线程或者应用线程访问过，从 M0 到 Remapped。  
标记阶段存在两个地址视图 M0 和 M1，区别前一次标记和当前标记，第二次进入并发标记阶段，地址视图调整为 M1，不活跃的为 M0。  
着色指针和读屏障技术不仅应用在并发转移阶段，还应用在并发标记阶段：将对象设为已标记，传统的垃圾回收器需要进行一次内存访问，并将对象存活信息放在对象头中；ZGC 只需设置指针地址 42~45 位即可，寄存器访问，速度比访问内存更快。
